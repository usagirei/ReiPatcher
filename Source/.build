<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Clean;Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<OutputPath>..\Build\</OutputPath>
		<Configuration>Git</Configuration>
		<DebugType>pdbonly</DebugType>
		<Optimize>true</Optimize>
		<ErrorReport>prompt</ErrorReport>
		<WarningLevel>4</WarningLevel>
		<DocumentationFile>..\Build\ExIni.xml</DocumentationFile>
	</PropertyGroup>
	
	<Import Project="ReiPatcher.csproj" />

	<!-- Start MSBuild Tasks -->
	<PropertyGroup>
		<MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\..\.build</MSBuildCommunityTasksPath>
	</PropertyGroup>
	<Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets" />
	<!-- End MSBuild Tasks -->

	<Target Name="BeforeBuild">
		<GitPendingChanges>
			<Output TaskParameter="HasPendingChanges" PropertyName="Dirty" />
		</GitPendingChanges>

		<PropertyGroup>
			<DefineConstants>GIT</DefineConstants>
			<DirtyTag Condition="'$(Dirty)' == 'True'">Dirty</DirtyTag>
		</PropertyGroup>

		<PropertyGroup Condition="'$(Platform)' == 'AnyCPU'">
			<DefineConstants >GIT;TRACE</DefineConstants>
			<PlatformTarget>AnyCPU</PlatformTarget>
		</PropertyGroup>
		
		<PropertyGroup Condition="'$(Platform)' == 'x86'">
			<DefineConstants >GIT;TRACE;X86</DefineConstants>
			<PlatformTarget>x86</PlatformTarget>
		</PropertyGroup>
		
		<PropertyGroup Condition="'$(Platform)' == 'x64'">
			<DefineConstants >GIT;TRACE;X64</DefineConstants>
			<PlatformTarget>x64</PlatformTarget>
		</PropertyGroup>
		
		<GitDescribe LightWeight="True" Match="v[0-9]*">
			<Output TaskParameter="Tag" PropertyName="VersionTag"/>
			<Output TaskParameter="CommitCount" PropertyName="Revision" />
		</GitDescribe>
		<GitVersion Short="False">
			<Output TaskParameter="CommitHash" PropertyName="CommitHash" />
		</GitVersion>
		<GitBranch>
			<Output TaskParameter="Branch" PropertyName="Branch" />
		</GitBranch>
		<AssemblyInfo CodeLanguage="CS" OutputFile="Properties\AssemblyVersion_Git.cs"
			AssemblyVersion="$(VersionTag.Substring(1)).$(Revision)"
			AssemblyFileVersion="$(VersionTag.Substring(1)).$(Revision)"
			AssemblyInformationalVersion="GIT $(Branch) [$(CommitHash)] $(DirtyTag)"/>
		<ItemGroup>
			<Compile Include="Properties\AssemblyVersion_Git.cs" />
		</ItemGroup>

		<ItemGroup Condition="'$(AIO)' == 'True'">
			<Reference Include="Mono.Cecil, Version=0.9.6.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756, processorArchitecture=MSIL">
				<SpecificVersion>False</SpecificVersion>
				<HintPath>..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.dll</HintPath>
				<Private>False</Private>
			</Reference>
			<Reference Include="Mono.Cecil.Mdb, Version=0.9.6.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756, processorArchitecture=MSIL">
				<SpecificVersion>False</SpecificVersion>
				<HintPath>..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Mdb.dll</HintPath>
				<Private>False</Private>
			</Reference>
			<Reference Include="Mono.Cecil.Pdb, Version=0.9.6.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756, processorArchitecture=MSIL">
				<SpecificVersion>False</SpecificVersion>
				<HintPath>..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Pdb.dll</HintPath>
				<Private>False</Private>
			</Reference>
			<Reference Include="Mono.Cecil.Rocks, Version=0.9.6.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756, processorArchitecture=MSIL">
				<SpecificVersion>False</SpecificVersion>
				<HintPath>..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Rocks.dll</HintPath>
				<Private>False</Private>
			</Reference>
			<Reference Include="ExIni, Version=1.0.1.0, Culture=neutral, processorArchitecture=x86">
				<SpecificVersion>False</SpecificVersion>
				<HintPath>..\..\ExIni\Releases\ExIni_1.0.1.1\ExIni.dll</HintPath>
				<Private>False</Private>
			</Reference>

			<EmbeddedResource Include="..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.dll">
				<Link>DLL\Mono.Cecil.dll</Link>
			</EmbeddedResource>
			<EmbeddedResource Include="..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Mdb.dll">
				<Link>DLL\Mono.Cecil.Mdb.dll</Link>
			</EmbeddedResource>
			<EmbeddedResource Include="..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Pdb.dll">
				<Link>DLL\Mono.Cecil.Pdb.dll</Link>
			</EmbeddedResource>
			<EmbeddedResource Include="..\packages\Mono.Cecil.0.9.6.1\lib\net35\Mono.Cecil.Rocks.dll">
				<Link>DLL\Mono.Cecil.Rocks.dll</Link>
			</EmbeddedResource>
			<EmbeddedResource Include="..\..\ExIni\Releases\ExIni_1.0.1.1\ExIni.dll">
				<Link>DLL\ExIni.dll</Link>
			</EmbeddedResource>
		</ItemGroup>

	</Target>
	<Target Name="AfterBuild">
		<Delete Files="Properties\AssemblyVersion_Git.cs" />
	</Target>
</Project>